(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[620],{1503:(e,s,t)=>{"use strict";t.d(s,{default:()=>a});var l=t(5155),n=t(2115),r=t(63);function a(e){let{blogId:s,initialLiked:t=!1,initialCount:a=0,userId:c,onLikeChange:i}=e,o=(0,r.useRouter)(),[d,x]=(0,n.useState)(t),[u,h]=(0,n.useState)(a),[m,g]=(0,n.useState)(!1),[p,f]=(0,n.useState)(null);(0,n.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/me",{method:"GET",credentials:"include"});if(!e.ok){console.log("Kh\xf4ng c\xf3 session, chuyển hướng đến /login"),f(!1);return}let s=await e.json();console.log("User session found:",s),f(!0)}catch(e){console.error("Lỗi kiểm tra session:",e),f(!1)}})()},[]);let b=async()=>{if(null===p)return void console.log("Đang kiểm tra session...");if(!p){console.log("Kh\xf4ng c\xf3 session, chuyển hướng đến /login"),o.push("/login");return}g(!0);try{console.log("Sending like request for blog:",s);let e=await fetch("/api/blog/".concat(s,"/like"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});if(console.log("Response status:",e.status),!e.ok){let s=await e.text();throw console.error("Server error:",s),Error("HTTP ".concat(e.status,": ").concat(s))}let t=await e.json();console.log("Like response:",t),x(t.liked);let l=t.liked?u+1:u-1;h(l),i&&i(l)}catch(e){console.error("Like error:",e),e instanceof Error&&e.message.includes("401")&&(console.log("Session invalid, redirecting to login"),o.push("/login"))}finally{g(!1)}};return(0,l.jsxs)("button",{onClick:b,disabled:m||null===p,className:"flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors flex-1 justify-center ".concat(m||null===p?"opacity-50 cursor-not-allowed":"hover:bg-gray-100"),children:[(0,l.jsx)("span",{className:d?"text-blue-500":"text-gray-600",children:"\uD83D\uDC4D"}),(0,l.jsx)("span",{className:"font-medium ".concat(d?"text-blue-600":"text-gray-600"),children:m?"Đang xử l\xfd...":d?"Đ\xe3 th\xedch":"Th\xedch"}),u>0&&(0,l.jsxs)("span",{className:"text-sm text-gray-500",children:["(",u,")"]})]})}},6971:(e,s,t)=>{Promise.resolve().then(t.bind(t,8172))},7840:(e,s,t)=>{"use strict";t.d(s,{A:()=>i});var l=t(5155),n=t(2619),r=t.n(n),a=t(6489),c=t(2115);function i(){let{data:e}=(0,a.useSession)(),[s,t]=(0,c.useState)(!1);return(0,l.jsx)("nav",{className:"bg-white shadow-sm border-b sticky top-0 z-50",children:(0,l.jsxs)("div",{className:"max-w-7xl mx-auto px-4 py-3",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)(r(),{href:"/",className:"text-2xl font-bold text-blue-600 hover:text-blue-700",children:"InstaClone"}),(0,l.jsxs)("div",{className:"hidden md:flex items-center space-x-6",children:[(0,l.jsxs)(r(),{href:"/home",className:"flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors",children:[(0,l.jsx)("span",{className:"text-xl",children:"\uD83C\uDFE0"}),(0,l.jsx)("span",{children:"Trang chủ"})]}),(0,l.jsxs)(r(),{href:"/search",className:"flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors",children:[(0,l.jsx)("span",{className:"text-xl",children:"\uD83D\uDD0D"}),(0,l.jsx)("span",{children:"T\xecm kiếm"})]}),(0,l.jsxs)(r(),{href:"/blog/create",className:"flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors",children:[(0,l.jsx)("span",{className:"text-xl",children:"➕"}),(0,l.jsx)("span",{children:"Tạo b\xe0i"})]}),(0,l.jsxs)(r(),{href:"/profile",className:"flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors",children:[(0,l.jsx)("span",{className:"text-xl",children:"\uD83D\uDC64"}),(0,l.jsx)("span",{children:"Trang c\xe1 nh\xe2n"})]}),e&&(0,l.jsxs)("button",{onClick:()=>(0,a.signOut)({redirect:!0,callbackUrl:"/login"}),className:"flex items-center space-x-2 text-gray-700 hover:text-red-600 transition-colors",children:[(0,l.jsx)("span",{className:"text-xl",children:"\uD83D\uDEAA"}),(0,l.jsx)("span",{children:"Đăng xuất"})]})]}),(0,l.jsx)("button",{onClick:()=>t(!s),className:"md:hidden text-2xl focus:outline-none",children:"☰"})]}),s&&(0,l.jsxs)("div",{className:"md:hidden mt-4 pb-4 space-y-3 border-t pt-4",children:[(0,l.jsx)(r(),{href:"/home",className:"block px-4 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",onClick:()=>t(!1),children:"\uD83C\uDFE0 Trang chủ"}),(0,l.jsx)(r(),{href:"/search",className:"block px-4 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",onClick:()=>t(!1),children:"\uD83D\uDD0D T\xecm kiếm"}),(0,l.jsx)(r(),{href:"/blog/create",className:"block px-4 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",onClick:()=>t(!1),children:"➕ Tạo b\xe0i"}),(0,l.jsx)(r(),{href:"/profile",className:"block px-4 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",onClick:()=>t(!1),children:"\uD83D\uDC64 Trang c\xe1 nh\xe2n"}),e&&(0,l.jsx)("button",{onClick:()=>{(0,a.signOut)({redirect:!0,callbackUrl:"/login"}),t(!1)},className:"block w-full text-left px-4 py-2 text-gray-700 hover:bg-red-50 rounded-lg transition-colors",children:"\uD83D\uDEAA Đăng xuất"})]})]})})}},8172:(e,s,t)=>{"use strict";t.d(s,{default:()=>p});var l=t(5155),n=t(2115),r=t(2619),a=t.n(r),c=t(4744),i=t(2992),o=t(1503),d=t(5125);function x(e){let s=new Map,t=[];return e.forEach(e=>{s.set(e.id,{...e,replies:[]})}),s.forEach(e=>{if(e.parentId){let t=s.get(e.parentId);null==t||t.replies.push(e)}else t.push(e)}),t}function u(e){let{blogId:s,currentUser:t}=e,[r,a]=(0,n.useState)([]),[c,i]=(0,n.useState)(""),[o,u]=(0,n.useState)(null),[m,g]=(0,n.useState)(!1);async function p(e){e.preventDefault(),c.trim()&&(await d.A.post("/api/blog/".concat(s,"/comment"),{content:c,parentId:o}),i(""),u(null),a(x((await d.A.get("/api/blog/".concat(s,"/comment"))).data)))}return(0,n.useEffect)(()=>{d.A.get("/api/blog/".concat(s,"/comment")).then(e=>{a(x(e.data))})},[s]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("button",{onClick:()=>g(!0),className:"text-sm text-blue-600 underline mt-2",children:["Hiển thị ",r.length," b\xecnh luận"]}),(0,l.jsxs)("div",{className:"fixed top-0 right-0 h-full w-full max-w-sm bg-white shadow-lg border-l z-50 transform transition-transform duration-300 ".concat(m?"translate-x-0":"translate-x-full"),children:[(0,l.jsxs)("div",{className:"flex justify-between items-center p-4 border-b bg-gray-50",children:[(0,l.jsx)("h2",{className:"text-lg font-semibold",children:"B\xecnh luận"}),(0,l.jsx)("button",{onClick:()=>g(!1),className:"text-red-500 text-sm",children:"Đ\xf3ng"})]}),(0,l.jsxs)("div",{className:"p-4 overflow-y-auto h-[calc(100%-64px)]",children:[t&&(0,l.jsxs)("form",{onSubmit:p,className:"mb-4",children:[o&&(0,l.jsxs)("div",{className:"text-sm text-blue-500 mb-1",children:["Trả lời một b\xecnh luận."," ",(0,l.jsx)("button",{onClick:()=>u(null),type:"button",className:"text-red-500 underline ml-2",children:"Huỷ"})]}),(0,l.jsx)("textarea",{value:c,onChange:e=>i(e.target.value),rows:2,placeholder:"Viết b\xecnh luận...",className:"w-full border rounded p-2 focus:outline-none focus:ring"}),(0,l.jsx)("button",{type:"submit",className:"mt-2 px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Gửi"})]}),(0,l.jsx)("div",{className:"space-y-3",children:r.map(e=>(0,l.jsx)(h,{comment:e,currentUser:t,onReply:u},e.id))})]})]})]})}function h(e){let{comment:s,currentUser:t,onReply:n}=e;return(0,l.jsxs)("div",{className:"ml-2 mt-2",children:[(0,l.jsxs)("div",{className:"p-2 bg-gray-100 rounded-lg border border-gray-200",children:[(0,l.jsxs)("p",{className:"text-sm font-medium text-gray-800",children:[s.author.fullname," ",(0,l.jsx)("span",{className:"text-gray-500 text-xs",children:new Date(s.createdAt).toLocaleString()})]}),(0,l.jsx)("p",{className:"text-sm text-gray-700",children:s.content}),t&&(0,l.jsx)("button",{onClick:()=>n(s.id),className:"text-xs text-blue-500 hover:underline mt-1",children:"Trả lời"})]}),s.replies.length>0&&(0,l.jsx)("div",{className:"ml-4 border-l pl-2 mt-2",children:s.replies.map(e=>(0,l.jsx)(h,{comment:e,currentUser:t,onReply:n},e.id))})]})}function m(e){let{blogId:s,currentUser:t}=e,[r,a]=(0,n.useState)(!1);return(0,l.jsxs)("div",{children:[(0,l.jsxs)("button",{onClick:()=>a(!r),className:"flex items-center space-x-2 px-4 py-2 hover:bg-gray-50 rounded-lg flex-1 justify-center transition-colors w-full",children:[(0,l.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDCAC"}),(0,l.jsx)("span",{className:"text-gray-600 font-medium",children:"B\xecnh luận"})]}),r&&(0,l.jsx)("div",{className:"mt-2",children:(0,l.jsx)(u,{blogId:s,currentUser:t})})]})}var g=t(7840);function p(){let[e,s]=(0,n.useState)([]),[t,r]=(0,n.useState)(null),[d,x]=(0,n.useState)(!0),u=async()=>{try{let[e,t]=await Promise.all([fetch("/api/me",{credentials:"include"}),fetch("/api/blog",{credentials:"include"})]);if(e.ok){let s=await e.json();r(s)}if(t.ok){let e=await t.json();s(e)}}catch(e){console.error("Error fetching data:",e)}finally{x(!1)}};return((0,n.useEffect)(()=>{u()},[]),(0,n.useEffect)(()=>{let e=()=>{u()};return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)},[]),(0,n.useEffect)(()=>{let e=setInterval(()=>{u()},1e4);return()=>clearInterval(e)},[]),d)?(0,l.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,l.jsx)(g.A,{}),(0,l.jsx)("main",{className:"max-w-2xl mx-auto p-4 pt-6",children:(0,l.jsx)("div",{className:"text-center",children:"Loading..."})})]}):(0,l.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,l.jsx)(g.A,{}),(0,l.jsxs)("main",{className:"max-w-2xl mx-auto p-4 pt-6",children:[(0,l.jsx)("h1",{className:"text-2xl font-bold mb-6 text-gray-800",children:"News Feed"}),(0,l.jsx)("div",{className:"space-y-4",children:e.map(n=>{var r;if(!(null==n?void 0:n.id)||!(null==n?void 0:n.author))return null;let d=n.author.id===(null==t?void 0:t.id)?"/profile":"/profile/".concat(n.author.id);return(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-md border hover:shadow-lg transition-shadow",children:[(0,l.jsx)("div",{className:"p-4 border-b",children:(0,l.jsx)(a(),{href:d,children:(0,l.jsxs)("div",{className:"flex items-center space-x-3 hover:bg-gray-50 -m-2 p-2 rounded-lg transition-colors",children:[(0,l.jsx)("div",{className:"w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center",children:(0,l.jsx)("span",{className:"text-gray-600 font-semibold text-sm",children:n.author.fullname.charAt(0).toUpperCase()})}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-semibold text-gray-800 hover:underline",children:n.author.fullname}),(0,l.jsx)("p",{className:"text-xs text-gray-500",children:(r=new Date(n.createdAt),(0,c.m)(new Date(r),{addSuffix:!0,locale:i.vi}))})]})]})})}),n.imageUrl&&(0,l.jsx)("div",{className:"aspect-square bg-gray-200 relative",children:(0,l.jsx)("img",{src:n.imageUrl,alt:n.caption,className:"w-full h-full object-cover"})}),(0,l.jsx)("div",{className:"p-4",children:(0,l.jsx)("p",{className:"text-gray-800",children:n.caption})}),(0,l.jsxs)("div",{className:"px-4 py-2 border-t border-b text-xs text-gray-600 space-y-1",children:[(0,l.jsxs)("p",{children:["\uD83D\uDC4D ",n._count.likes," lượt th\xedch"]}),(0,l.jsxs)("p",{children:["\uD83D\uDCAC ",n._count.comments," b\xecnh luận"]})]}),(0,l.jsxs)("div",{className:"p-4 flex gap-2",children:[(0,l.jsx)(o.default,{blogId:n.id,onLikeChange:t=>{s(e.map(e=>e.id===n.id?{...e,_count:{...e._count,likes:t}}:e))}}),(0,l.jsx)(m,{blogId:n.id})]})]},n.id)})})]})]})}}},e=>{e.O(0,[619,489,82,441,493,358],()=>e(e.s=6971)),_N_E=e.O()}]);